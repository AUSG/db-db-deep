# 7장: 트랜잭션과 동시성 제어
* `Transaction (트랜잭션)`: 복수개의 쿼리를 묶은 단위
* MySQL에서는 트랜잭션을 사용할 수 없는 단순한 구조의 MyISAM형과 일반적인 DBMS와 똑같은 트랜잭션 구조를 사용할 수 있는 InnoDB형 종류가 있다. (여기선 InnoDB 사용)
* 트랜잭션 특성
  * `Atomicity`: 원자성
  * `Consistency`: 일관성
  * `Isolation`: 독립성
  * `Durability`: 지속성

## 1. Atomicity (원자성)
* 데이터 변경(INSERT/UPDATE/DELETE)을 수반하는 일련의 데이터 조작이 전부 성공할지, 전부 실패할지를 보증하는 성질
* 모든 데이터 조작이 성공하면 COMMIT, COMMIT된 데이터는 영구적으로 저장되어 결과가 손실되지 않는다.
* 중간에 실패하면 모두 ROLLBACK, 데이터 조작 이전 상태로 돌아감

## 2. Consistency (일관성)
* 데이터 조작 후에도 데이터베이스가 일관된 상태를 유지되는 것을 보증하는 성질
* 데이터 베이스에 적용한 제약조건(PRIMARY KEY, UNIQUE, NOT NULL 등)을 위반하지 않은 상태 보장
* ex) UNIQUE 제약조건으로 설정한 column에는 중복된 값 삽입 불가

## 3. Isolation (독립성)
* 일련의 데이터 조작을 복수의 사용자가 동시에 실행해도 각각의 처리가 모순없이 처리되는 것을 보증하는 성질
* 여러 사용자가 같은 테이블에서 동시에 읽고 쓰기 작업을 할 때, 각각의 트랜잭션을 격리해 서로 방해하거나 영향을 미치지 않도록 보증

**예시) 호텔에 남은 객실 개수가 10개인 경우, 객실 예약 로직**
* 1 - 현재 남은 객실 수를 확인한다 (SELECT)
* 2 - 객실 예약 후 남은 객실 수를 1 감소한다. (UPDATE)
* 만약 A,B 사용자가 동시에 예약한다면? 두 사용자 모두 남은 객실 수를 10으로 읽어들여, 객실 수는 1만 감소하게 된다.
* ~~~~ 사진 ~~~~~
* 이런 사태를 막기 위해 데이터베이스에는 Lock을 걸어 후속 트랜잭션을 Block할 수 있다.
* 잠금 단위에는 테이블 전체, 블록, 행 등이 있다. (MySQL에서 트랜잭션을 처리할 때는 주로 행 단위 사용)
* `SELECT ~ FOR UPDATE` 를 실행하면 SELECT한 행에 Lock이 걸린다.
* 후속 트랜잭션은 Lock이 해제될 때 (COMMIT or ROLLBACK)까지 대기하게 된다.
* 그 결과, 아래와 같이 트랜잭션이 순서대로 실행되게 된다.
* ~~~~~~ 사진 ~~~~~

**DBMS 격리 수준: Transaction Isolation Level**
* 트랜잭션이 순차적으로 실행되는 직렬화 가능은 성능면에서 효율적이지 않다.
* 따라서, 격리 수준을 완화해 다른 트랜잭션의 영향받는 것을 허용하는 4단계를 ANSI에서 정의
* `Read Uncommitted`: 커밋되지 않은 읽기
* `Read committed`: 커밋된 읽기
* `Repeatable Read`: 반복 읽기
* `Serializable`: 직렬화 가능
* https://mangkyu.tistory.com/299


## 궁금한 점
* 200p) 'InnoDB형의 테이블은 MVCC라는 구조로 동작하기 때문에 이번 예에서 사용자가 B가 단순히 값을 참조하는 경우에는 SELECT에 FOR UPDATE는 불필요하며, 이 경우 읽기는 블록되지 않습니다.' 잘 이해가 되지 않습니다.
* MVCC 구조로 동작하기 때문에 단순 SELECT 시에는 Block을 시킬 수 없다는 건가? 
* MVCC란? [https://devlog-wjdrbs96.tistory.com/368](https://mangkyu.tistory.com/288)https://mangkyu.tistory.com/288
